name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-snap:
    name: Build Snap Package
    runs-on: ubuntu-24.04  # Snap uses core24 base, so build on 24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install snapcraft
        run: |
          sudo snap install snapcraft --classic

      - name: Install ALL build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            make \
            meson \
            ninja-build \
            pkg-config \
            libgtk-4-dev \
            libadwaita-1-dev \
            libglib2.0-dev \
            glib-networking \
            libglib2.0-bin \
            gettext \
            desktop-file-utils \
            appstream \
            libxml2-utils \
            curl \
            ca-certificates

      - name: Install Rust via rustup (>=1.85)
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.85.0
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          $HOME/.cargo/bin/rustc -V
          $HOME/.cargo/bin/cargo -V

      - name: Build snap
        run: |
          snapcraft pack --destructive-mode

      - name: Get version from tag
        id: get_version
        run: |
          # Extract version from tag (e.g., v1.1.0 -> 1.1.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Find the actual snap file
          SNAP_FILE=$(ls *.snap)
          echo "snap_file=$SNAP_FILE" >> $GITHUB_OUTPUT

      - name: Upload snap to release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./${{ steps.get_version.outputs.snap_file }}
          asset_name: bootmate_${{ steps.get_version.outputs.version }}_amd64.snap
          asset_content_type: application/octet-stream

      - name: Upload snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: snap-package
          path: '*.snap'

  build-deb:
    name: Build DEB Package
    runs-on: ubuntu-latest
    container:
      image: ubuntu:25.10  # DEB needs GTK 4.20 from Ubuntu 25.10

    steps:
      - name: Install git and basic tools
        run: |
          apt-get update
          apt-get install -y git curl ca-certificates

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ALL build dependencies
        run: |
          apt-get install -y \
            build-essential \
            gcc \
            make \
            meson \
            ninja-build \
            pkg-config \
            libgtk-4-dev \
            libadwaita-1-dev \
            libglib2.0-dev \
            glib-networking \
            libglib2.0-bin \
            gettext \
            desktop-file-utils \
            appstream \
            libxml2-utils

      - name: Install Rust via rustup (>=1.85)
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain 1.85.0
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          $HOME/.cargo/bin/rustc -V
          $HOME/.cargo/bin/cargo -V

      - name: Install cargo-deb
        run: |
          cargo install cargo-deb

      - name: Build with meson (for resources)
        run: |
          meson setup build-release --prefix=/usr -Dprofile=release
          meson compile -C build-release

      - name: Build DEB package
        run: |
          cargo deb

      - name: Get version from tag
        id: get_version
        run: |
          # Extract version from tag (e.g., v1.1.0 -> 1.1.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # Find the actual deb file
          DEB_FILE=$(ls target/debian/*.deb | xargs -n 1 basename)
          echo "deb_file=$DEB_FILE" >> $GITHUB_OUTPUT

      - name: Upload deb to release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./target/debian/${{ steps.get_version.outputs.deb_file }}
          asset_name: bootmate_${{ steps.get_version.outputs.version }}_amd64.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: target/debian/*.deb
